defaults:
  module:
    context: avr8_common

contexts:
  - name: avr8_common
    parent: riot
    selects:
      - arch_8bit
      - arch_avr8
      - avr8_common
      - avr_libc_extra
      - core_idle_thread
      # The AVR-libc provides no strerror, so we provide it via tiny_strerror
      - tiny_strerror_as_strerror

    disables:
      # causes internal compiler error on gcc 11.2.0
      - lto
    env:
      PREFIX: avr-
      LINKFLAGS:
        - -Wl,--defsym=__TEXT_REGION_LENGTH__=${ROM_LEN}-${RAM_LEN}
        - -Wl,--defsym=__DATA_REGION_LENGTH__=${RAM_LEN}
        # Add aliases for flash_printf, flash_fprintf, flash_snprintf:
        - -Wl,--defsym=flash_printf=printf_P
        - -Wl,--defsym=flash_fprintf=fprintf_P
        - -Wl,--defsym=flash_snprintf=snprintf_P
        - -e reset_handler
      CFLAGS_ARCH:
        # this is required as workaround for avr-gcc 12.x.
        # unfortunately it breaks avr-gcc < 11.3.
        - --param=min-pagesize=0
        - -fno-builtin
      CFLAGS_STD: -std=gnu11
      includes:
        - ${relpath}/include

modules:
  - name: avr8_common
    depends:
      - board
    sources:
      - avr8_cpu.c
      - startup.c
      - thread_arch.c

  # features
  - name: arch_8bit
  - name: arch_avr8
    #- name: cpp

subdirs:
  - avr_libc_extra
